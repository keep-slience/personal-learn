<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        code {
            color: #ffffff;
            background: #000000;
        }

        pre {
            background: #000000;

        }

        .float1 {
            right: 0;
            bottom: 0;
            display: block;
            width: 100%;
            height: 600px;
            background: #f0f0f0;
            /* background: radial-gradient(red, green, blue); 标准的语法 */
        }
    </style>
</head>

<body>
    <h1>es6 Promise（承诺）</h1>
    <div class="float1">
        <!-- <iframe width="100%" height="600px" src="editor.html" frameborder="0"></iframe> -->
        <!-- <a href="editor.html" target="view_window">打开在线编辑器</a> -->
    </div>
    <p>Promise对象是一个构造函数，用来生成一个promise实例。</p>

    <code>
            <pre>
                const promise = new Promise(function(resolve, reject) {
                // ... some code

                    if (/* 异步操作成功 */){
                        return resolve(value);
                    } else {
                        return reject(error);
                    }
                    //由于promise的状态无法改变，所以应该在resolve/reject前写上return
                    //阻止后面的事件发生
                });
            </pre>

        </code>
    <p>Promise构造函数接受一个函数作为参数，该函数的两个参数分别是resolve和reject。它们是两个函数，由 JavaScript 引擎提供，不用自己部署。</p>
    <p>resolve函数的作用是，将Promise对象的状态从“未完成”变为“成功”（即从 pending 变为 resolved），在异步操作成功时调用，并将异步操作的结果，作为参数传递出去；reject函数的作用是，将Promise对象的状态从“未完成”变为“失败”（即从
        pending 变为 rejected），在异步操作失败时调用，并将异步操作报出的错误，作为参数传递出去。</p>

    <hr/>
    <p>Promise实例生成以后，可以用then方法分别指定resolved状态和rejected状态的回调函数。</p>
    <code>
            <pre>
                promise.then(function(value) {
                    // success
                }, function(error) {
                    // failure
                });
            </pre>

        </code>

    <hr/>

    <p>Promise 正确的写法</p>
    <code>
            <pre>
                function printHello (ready) {
                    return new Promise(function (resolve, reject) {
                        if (ready) {
                            resolve("Hello");
                        } else {
                            reject("Good bye!");
                        }
                    });
                }
                
                printHello(true).then(function (message) {
                    return message;
                },function (error){
                    return "error:"+error;
                }).then(function (message) {
                    return message  + ' World';
                }).then(function (message) {
                    return message + '!';
                }).then(function (message) {
                    alert(message);
                });
            </pre>

        </code>

    <hr/>

    
    <p>Promise </p>
    <code>
        <pre>
            function printHello (ready) {
                return new Promise(function (resolve, reject) {
                    if (ready) {
                        resolve("Hello");
                    } else {
                        reject("Good bye!");
                    }
                });
            }
            
            printHello(true).then(function (message) {
                return message;
            },function (error){
                return "error:"+error;
            }).then(function (message) {
                return message  + ' World';
            }).then(function (message) {
                return message + '!';
            }).then(function (message) {
                alert(message);
            });
        </pre>

    </code>

    <hr/>

</body>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>
    window.onload = function () {

        function promise1(){
            return new Promise(function(resolve){
                
                console.log("请求1");
                setTimeout(function(){  
                    
                    return resolve("bilibili干杯！");  
                },2000);  
                
                console.log("请求1结束");
    
            })
        }
        

        function run(){
            promise1().then(function(resolve){
                console.log(resolve);
                return resolve//传递到下个then()
            }).then(function(resolve){
                console.log(resolve+"我是resolve2")
                return resolve+"来自then()2"
            }).catch(function(error){
                console.error("错误信息："+error)
            }).finally(function(){
                console.log("finally")
            })
        }
        run();
        

        const p1 = function(){
            return new Promise(function(){
                setTimeout(function(){  
                    return resolve("P1");  
                },1000);  
            })
        }
        const p2 = function(){
            return new Promise(function(){
                setTimeout(function(){  
                    return resolve("P2");  
                },2000);  
            })
        }
        const p3 = function(){
            return new Promise(function(){
                setTimeout(function(){  
                    return resolve("P3");  
                },3000);  
            })
        }
        
        // const p = Promise.all([p1,p2,p3]).then(function(resolve){
        //     p.map(() =>{
        //         forEach((x) => {
        //             console.log(x)
        //         })
        //     })
        //     return resolve("成功")
        // });
        
        
        const promises = [2, 3, 5, 7, 11, 13].map(function (id) {
            return alert('/post/' + id + ".json");
        });

        Promise.all(promises).then(function (posts) {
            // ...
        }).catch(function(reason){
            // ...
        });

    }
</script>

</html>